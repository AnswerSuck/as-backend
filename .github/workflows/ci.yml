name: CI

on: pull_request

jobs:

  tests:
    name: runner / tests
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Install Go
      uses: actions/setup-go@v3
      with:
        go-version: 1.18

    - name: Unit tests
      run: "go test \
        -v \
        -race \
        -covermode atomic \
        -coverprofile=coverage.txt \
        ./internal/... \
        ./pkg/..."
    - name: Upload coverage report
      run: bash <(curl -s https://codecov.io/bash)

    - name: Integration tests
      run: "docker-compose up \
        --build \
        --abort-on-container-exit \
        --exit-code-from integration"
      env:
        PG_URL: ${{ secrets.TEST_PG_URL }}
        SMTP_FROM: ${{ secrets.TEST_SMTP_FROM }}
        SMTP_PASSWORD: ${{ secrets.TEST_SMTP_PASSWORD }}
        FILE_STORAGE_ACCESS_KEY: ${{ secrets.TEST_FILE_STORAGE_ACCESS_KEY }}
        FILE_STORAGE_SECRET_KEY: ${{ secrets.TEST_FILE_STORAGE_SECRET_KEY }}
